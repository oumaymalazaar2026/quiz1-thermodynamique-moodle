<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thermo : Le Collectionneur</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes shine { 0% { background-position: -200% } 100% { background-position: 200% } }
        .rarity-legendary { 
            background: linear-gradient(90deg, #ffd700, #fff5b1, #ffd700);
            background-size: 200% auto;
            animation: shine 3s linear infinite;
            border: 2px solid #b8860b;
        }
        .rarity-rare { border: 2px solid #805ad5; background-color: #faf5ff; }
        .rarity-common { border: 2px solid #e2e8f0; background-color: #ffffff; }
        .card-pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .badge-glow { filter: drop-shadow(0 0 20px rgba(234, 179, 8, 0.9)); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        #timer-bar { transition: width 1s linear; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col font-sans text-slate-900">

<header class="bg-indigo-950 text-white p-6 shadow-2xl flex justify-between items-center border-b-4 border-yellow-500">
    <div>
        <h1 class="text-2xl font-black uppercase tracking-tight">Mission : Le Collectionneur</h1>
        <p class="text-indigo-300 text-sm italic">Outils math√©matiques et notions fondamentales de la thermodynamique</p>
    </div>
    <div class="text-right">
        <span class="text-xl font-bold block leading-none">LAZAAR Oumayma</span>
        <span class="text-[10px] bg-indigo-700 px-2 py-1 rounded text-white mt-2 inline-block uppercase font-bold tracking-widest">Architecte P√©dagogique</span>
    </div>
</header>

<main class="flex-grow p-4 md:p-8 max-w-5xl mx-auto w-full">

    <div class="flex justify-between items-center mb-2 px-2">
        <span class="text-xs font-bold text-slate-500 uppercase tracking-widest">Ma√Ætrise des concepts</span>
        <span class="text-sm font-black text-indigo-900 uppercase">Points : <span id="live-score" class="text-2xl text-indigo-600">0</span>/8</span>
    </div>
    <div class="mb-8 bg-slate-200 rounded-full h-3 overflow-hidden p-0.5">
        <div id="progress-bar" class="bg-indigo-600 h-full rounded-full transition-all duration-500 w-0"></div>
    </div>

    <section id="game-container" class="bg-white rounded-3xl shadow-xl p-6 md:p-10 mb-10 border border-slate-200 min-h-[480px] flex items-center justify-center">
        <div id="quiz-box" class="w-full">
            <div class="text-center py-10">
                <span class="text-7xl mb-6 block">üîê</span>
                <h2 class="text-3xl font-black text-slate-800 mb-4">8 Verrous √† Ouvrir</h2>
                <p class="text-slate-500 mb-8 max-w-md mx-auto italic text-lg">
                    Calculez les d√©riv√©es et coefficients du TD1 pour vider le coffre.
                </p>

                <!-- Champ pour le nom de l'√©tudiant -->
                <input id="studentName" 
                       type="text" 
                       placeholder="Entrez votre nom" 
                       class="mb-2 px-4 py-3 rounded-xl border border-slate-300 w-80 text-center font-bold focus:outline-none focus:ring-2 focus:ring-indigo-500" />

                <!-- Message d'erreur si nom vide -->
                <p id="nameError" class="text-red-600 text-sm hidden mb-4">
                    Veuillez entrer votre nom pour commencer le quiz.
                </p>

                <button onclick="startMission()" 
                        class="bg-indigo-600 hover:bg-indigo-700 text-white text-xl font-bold py-4 px-12 rounded-2xl shadow-lg transition-all hover:scale-105">
                    Lancer la Mission
                </button>
            </div>
        </div>
    </section>

    <section>
        <div class="flex flex-col md:flex-row justify-between items-end mb-6 gap-4">
            <h3 class="text-2xl font-black text-indigo-950 uppercase flex items-center gap-3">
                üìú Grimoire des Concepts <span id="badge-count" class="bg-indigo-950 text-white text-sm px-3 py-1 rounded-full">0</span>
            </h3>
        </div>
        <div id="inventory-grid" class="grid grid-cols-2 md:grid-cols-5 gap-4 p-6 bg-slate-200/50 rounded-3xl border-2 border-dashed border-slate-300 min-h-[150px]">
            <p class="col-span-full text-center text-slate-400 py-6 italic text-sm">Votre inventaire est pr√™t √† recevoir vos succ√®s.</p>
        </div>
    </section>
</main>

<script>
const originalDatabase = [
    { q: "Ex 1.a : ‚àÇf/‚àÇx pour f(x,y)=2x¬≤+y¬≥ au point (x=1, y=2).", options: ["4", "3", "2"], correctText: "4", concept: "D√©riv√©e Partielle", exp: "‚àÇf/‚àÇx = 4x. Pour x=1, le r√©sultat est 4." },
    { q: "Ex 1.c : ‚àÇf/‚àÇy pour f(x,y)=x¬≤/y + y¬≤/x au point (1,1).", options: ["1", "2", "0"], correctText: "1", concept: "Fonction Inverse", exp: "‚àÇf/‚àÇy = -x¬≤/y¬≤ + 2y/x. En (1,1) : -1 + 2 = 1." },
    { q: "Ex 2.b : Si f=x¬≥y, calculez df pour x=1, y=1, dx=1 et dy=0.", options: ["3", "1", "0"], correctText: "3", concept: "Diff√©rentielle", exp: "df = (3x¬≤y)dx + (x¬≥)dy. Ici : 3*1*1 + 0 = 3." },
    { q: "Ex 3.2 : Pour df=2xydx + x¬≤dy, que vaut ‚àÇ¬≤f/‚àÇy‚àÇx ?", options: ["2", "1", "0"], correctText: "2", concept: "Schwartz", exp: "On d√©rive 2xy par rapport √† y. En x=1, le r√©sultat est 2." },
    { q: "Ex 9.f : Valeur de Œ±.T pour un gaz parfait ?", options: ["1", "0", "-1"], correctText: "1", concept: "Gaz Parfait", exp: "Œ± = 1/T. Donc Œ±*T = 1." },
    { q: "Ex 2.a : ‚àÇf/‚àÇx pour f=x.sin(y) au point (x=5, y=0).", options: ["0", "5", "1"], correctText: "0", concept: "Trigonom√©trie", exp: "‚àÇf/‚àÇx = sin(y). sin(0) = 0." },
    { q: "Ex 9.d : Unit√© de Œ± = (1/V)(‚àÇV/‚àÇT)p ?", options: ["K", "K‚Åª¬π", "Pa‚Åª¬π"], correctText: "K‚Åª¬π", concept: "Unit√©s SI", exp: "Le coefficient de dilatation Œ± est en K‚Åª¬π." },
    { q: "Ex 9.c : Valeur de (‚àÇT/‚àÇP)v (‚àÇP/‚àÇV)t (‚àÇV/‚àÇT)p ?", options: ["-1", "0", "1"], correctText: "-1", concept: "Relation Triple", exp: "C'est la relation cyclique fondamentale, elle vaut toujours -1." }
];

let database = [];
let currentIdx = 0;
let score = 0;
let inventory = [];
let userChoices = [];
let timer;
let timeLeft;
const TIME_LIMIT = 15;

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function startMission() {
    const studentNameInput = document.getElementById("studentName");
    const studentName = studentNameInput.value.trim();

    if (!studentName) {
        document.getElementById("nameError").classList.remove("hidden");
        studentNameInput.focus();
        return;
    } else {
        document.getElementById("nameError").classList.add("hidden");
    }

    window.currentStudentName = studentName;

    database = shuffleArray([...originalDatabase]);
    database.forEach(q => q.options = shuffleArray([...q.options]));
    currentIdx = 0;
    score = 0;
    inventory = [];
    userChoices = [];
    updateStats();
    renderInventory();
    showQuestion();
}

function updateStats() {
    document.getElementById('live-score').innerText = score;
    document.getElementById('progress-bar').style.width = `${(currentIdx / database.length) * 100}%`;
    document.getElementById('badge-count').innerText = inventory.length;
}

function showQuestion() {
    if (currentIdx >= database.length) {
        clearInterval(timer);
        renderEndScreen();
        return;
    }

    updateStats();
    const data = database[currentIdx];

    let html = `
        <div class="card-pop w-full">
            <span class="text-indigo-600 font-black uppercase text-[10px] tracking-[0.2em]">Verrou ${currentIdx + 1} sur ${database.length}</span>
            <h2 class="text-2xl font-bold mt-4 mb-8 text-slate-800 leading-tight">${data.q}</h2>
            <div class="grid gap-4">
    `;
    data.options.forEach((opt) => {
        html += `
            <button onclick="handleSelection('${opt.replace(/'/g, "\\'")}')" class="text-left p-5 rounded-2xl border-2 border-slate-100 hover:border-indigo-600 hover:bg-indigo-50 transition-all font-semibold flex justify-between items-center group active:scale-95">
                ${opt}
                <span class="opacity-0 group-hover:opacity-100 transition-all">Choisir ‚ûú</span>
            </button>`;
    });
    html += `</div></div>`;
    document.getElementById('quiz-box').innerHTML = html;
}

function handleSelection(selectedText) {
    const data = database[currentIdx];
    const studentName = window.currentStudentName || "Anonyme";
    const isCorrect = selectedText === data.correctText;

    saveAnswer(studentName, data.q, selectedText, isCorrect);

    if (isCorrect) {
        score++;
        generateLoot(data.concept);
        userChoices.push({ selected: selectedText, correct: true });
        document.getElementById('quiz-box').innerHTML = `
            <div class="card-pop text-center py-6">
                <div class="text-6xl mb-6">üîì</div>
                <h2 class="text-3xl font-black text-green-600 mb-4">Correct !</h2>
                <p class="text-slate-600 mb-8 px-6 max-w-md mx-auto italic">${data.exp}</p>
                <button onclick="proceedToNext()" class="bg-slate-900 text-white px-12 py-4 rounded-2xl font-bold hover:bg-indigo-600 transition-all shadow-lg">Continuer</button>
            </div>`;
    } else {
        userChoices.push({ selected: selectedText, correct: false });
        document.getElementById('quiz-box').innerHTML = `
            <div class="card-pop text-center py-6">
                <div class="text-6xl mb-6">üö®</div>
                <h2 class="text-3xl font-black text-amber-600 mb-4">Incorrect</h2>
                <p class="text-slate-600 mb-8 px-6 max-w-md mx-auto italic">${data.exp}</p>
                <button onclick="proceedToNext()" class="bg-slate-900 text-white px-12 py-4 rounded-2xl font-bold hover:bg-indigo-600 transition-all shadow-lg">Suivant</button>
            </div>`;
    }
}

function proceedToNext() {
    currentIdx++;
    showQuestion();
}

function generateLoot(conceptName) {
    const rand = Math.random();
    let rarity = rand > 0.85 ? "legendary" : (rand > 0.60 ? "rare" : "common");
    inventory.push({ name: conceptName, rarity: rarity, emoji: "üìú" });
    renderInventory();
}

function renderInventory() {
    const grid = document.getElementById('inventory-grid');
    if (inventory.length === 0) {
        grid.innerHTML = `<p class="col-span-full text-center text-slate-400 py-6 italic text-sm">Votre inventaire est pr√™t √† recevoir vos succ√®s.</p>`;
        return;
    }
    grid.innerHTML = inventory.map(item => `
        <div class="card-pop p-3 rounded-2xl shadow-sm text-center border bg-white rarity-${item.rarity} transition-transform hover:scale-110">
            <span class="text-2xl block mb-1">${item.emoji}</span>
            <span class="text-[9px] font-black uppercase text-indigo-950 block leading-tight">${item.name}</span>
        </div>
    `).join('');
}

function renderEndScreen() {
    updateStats();
    let mention = score === database.length ? "GRAND MA√éTRE" : (score >= database.length*0.7 ? "EXPERT" : "APPRENTI");
    document.getElementById('quiz-box').innerHTML = `
        <div class="text-center py-4 card-pop">
            ${score === database.length ? '<div class="badge-glow text-8xl mb-6">üéñÔ∏è</div>' : '<div class="text-6xl mb-6">üèÅ</div>'}
            <h2 class="text-6xl font-black text-indigo-950 mb-2">${score}/${database.length}</h2>
            <p class="text-xl font-bold text-slate-500 mb-10 tracking-widest uppercase">STATUT : ${mention}</p>
            <div class="flex flex-col md:flex-row gap-4 justify-center">
                <button onclick="showDetailedCorrection()" class="bg-indigo-600 text-white px-10 py-4 rounded-2xl font-black hover:bg-indigo-700 shadow-xl transition-all">ANALYSER LE RAPPORT</button>
                <button onclick="location.reload()" class="bg-slate-200 text-slate-700 px-10 py-4 rounded-2xl font-bold hover:bg-slate-300 transition">RECOMMENCER</button>
            </div>
        </div>`;
}

function showDetailedCorrection() {
    let html = `<div class="card-pop text-left max-w-3xl mx-auto"><h2 class="text-2xl font-black text-indigo-950 uppercase mb-6 border-b pb-4 tracking-tighter">Rapport de Ma√Ætrise</h2><div class="space-y-4 max-h-[500px] overflow-y-auto pr-4">`;
    database.forEach((data, i) => {
        const uc = userChoices[i];
        html += `
            <div class="p-6 rounded-3xl border-2 ${uc.correct ? 'border-green-100 bg-green-50' : 'border-red-100 bg-red-50'}">
                <p class="font-black text-slate-800">${i+1}. ${data.q}</p>
                <p class="text-sm mt-2"><strong>Votre choix :</strong> <span class="${uc.correct ? 'text-green-600' : 'text-red-600'}">${uc.selected}</span></p>
                ${!uc.correct ? `<p class="text-sm text-green-700 font-bold">R√©ponse correcte : ${data.correctText}</p>` : ''}
                <div class="mt-4 p-4 bg-white/80 rounded-2xl text-xs text-slate-600 border border-white leading-relaxed italic">
                    <strong>Note p√©dagogique :</strong> ${data.exp}
                </div>
            </div>`;
    });
    html += `</div><button onclick="renderEndScreen()" class="mt-6 w-full py-4 bg-slate-100 font-bold rounded-xl hover:bg-slate-200 transition">Fermer le rapport</button></div>`;
    document.getElementById('quiz-box').innerHTML = html;
}

// Fonction pour envoyer les r√©ponses √† Google Sheets
function saveAnswer(nom, question, reponse, correct) {
    fetch("TON_URL_GOOGLE_SCRIPT", {
        method: "POST",
        body: JSON.stringify({ nom, question, reponse, correct })
    });
}
</script>
</body>
</html>
