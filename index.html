<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thermo : Le Code du Coffre (8 Niveaux)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    body { background-color: #f5f2e9; font-family: sans-serif; }
    .vault-wheel { background: linear-gradient(#3e2723, #5d4037, #3e2723); border: 2px solid #d4a373; color: white; font-weight: bold; border-radius: 0.5rem; text-shadow: 0 0 10px rgba(250,237,205,0.5);}
    .shake { animation: shake 0.2s ease-in-out 0s 2; }
    @keyframes shake { 0%,100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }
    .card-pop { animation: pop 0.4s cubic-bezier(0.175,0.885,0.32,1.275); }
    @keyframes pop { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    .rarity-gold { border: 2px solid #b8860b; background: linear-gradient(135deg, #ffd700, #faf5b1); box-shadow: 0 4px 10px rgba(184,134,11,0.3);}
</style>
</head>
<body class="bg-antique min-h-screen text-stone-900">

<header class="bg-[#3e2723] text-[#faedcd] p-4 shadow-xl border-b-4 border-[#bc6c25] flex justify-between items-center">
    <div>
        <h1 class="font-black uppercase tracking-tighter text-xl">Mission : Le Coffre-Fort</h1>
        <p class="text-[10px] text-[#d4a373] uppercase tracking-widest font-bold">TD1 : Outils Math√©matiques</p>
    </div>
    <div class="text-right border-l border-[#d4a373] pl-4">
        <input id="studentName" type="text" placeholder="Votre nom" class="px-2 py-1 rounded text-[#3e2723] font-bold" />
    </div>
</header>

<main class="p-6 max-w-2xl mx-auto">

    <div class="flex justify-between text-[10px] font-bold uppercase mb-1 text-stone-500">
        <span>D√©chiffrement en cours</span>
        <span id="score-text">Niveau 0/8</span>
    </div>
    <div class="h-3 bg-stone-300 rounded-full mb-8 overflow-hidden p-0.5 border border-stone-200">
        <div id="prog-bar" class="h-full bg-[#8b4513] w-0 transition-all duration-700 rounded-full"></div>
    </div>

    <section id="game-zone" class="bg-white rounded-3xl shadow-2xl p-8 border-2 border-stone-200 relative overflow-hidden">
        <div id="quiz-content" class="text-center py-12">
            <div class="text-7xl mb-6">üîê</div>
            <h2 class="text-3xl font-black text-[#3e2723] mb-4 uppercase tracking-tighter">8 Verrous √† Ouvrir</h2>
            <p class="text-stone-500 italic mb-10 max-w-xs mx-auto">Calculez les d√©riv√©es et coefficients du TD1 pour vider le coffre.</p>
            <button onclick="startMission()" class="bg-[#3e2723] text-[#faedcd] px-12 py-4 rounded-xl font-bold hover:bg-black transition-all shadow-xl active:scale-95">Lancer l'Analyse</button>
        </div>
    </section>

    <div class="mt-12">
        <h3 class="text-xs font-black text-[#3e2723] uppercase mb-4 tracking-widest border-b border-stone-300 pb-2">üìú Grimoire des Concepts (Badges)</h3>
        <div id="inventory" class="flex flex-wrap gap-3 justify-start min-h-[60px]">
            <p id="empty-inv" class="text-xs italic text-stone-400">R√©ussissez un calcul pour gagner un badge...</p>
        </div>
    </div>
</main>

<script>
const questions = [
    {id:1, concept:"D√©riv√©e Partielle", q:"Ex 1.a : ‚àÇf/‚àÇx pour f(x,y)=2x¬≤+y¬≥ au point (1,2).", answer:"4", hint:"‚àÇf/‚àÇx = 4x ‚Üí x=1 ‚áí 4"},
    {id:2, concept:"Fonction Inverse", q:"Ex 1.c : ‚àÇf/‚àÇy pour f(x,y)=x¬≤/y + y¬≤/x au point (1,1).", answer:"1", hint:"‚àÇf/‚àÇy = -x¬≤/y¬≤ + 2y/x ‚Üí 1"},
    {id:3, concept:"Diff√©rentielle", q:"Ex 2.b : Si f=x¬≥y, calculez df pour x=1,y=1,dx=1,dy=0.", answer:"3", hint:"df = (3x¬≤y)dx + x¬≥dy =3"},
    {id:4, concept:"Schwartz", q:"Ex 3.2 : df=2xydx + x¬≤dy, ‚àÇ¬≤f/‚àÇy‚àÇx ?", answer:"2", hint:"D√©river 2xy par y ‚Üí 2x"},
    {id:5, concept:"Gaz Parfait", q:"Ex 9.f : Valeur de Œ±.T ?", answer:"1", hint:"Œ± = 1/T ‚Üí Œ±*T =1"},
    {id:6, concept:"Trigonom√©trie", q:"Ex 2.a : ‚àÇf/‚àÇx pour f=x*sin(y) au point (5,0).", answer:"0", hint:"sin(0)=0"},
    {id:7, concept:"Unit√©s SI", q:"Ex 9.d : Unit√© Œ± = (1/V)(‚àÇV/‚àÇT)p ? (0:K,1:K‚Åª¬π,2:Pa‚Åª¬π)", answer:"1", hint:"Œ± en K‚Åª¬π"},
    {id:8, concept:"Relation Triple", q:"Ex 9.c : (‚àÇT/‚àÇP)v (‚àÇP/‚àÇV)t (‚àÇV/‚àÇT)p ?", answer:"-1", hint:"Relation cyclique = -1"}
];

let currentIdx=0, score=0, hasRetried=false, userLog=[], attemptNumber=1;

function startMission(){
    const nameInput = document.getElementById("studentName").value.trim();
    if(!nameInput){ alert("Veuillez entrer votre nom"); return; }
    window.currentStudentName = nameInput;
    currentIdx=0; score=0; hasRetried=false; attemptNumber=1; userLog=[]; document.getElementById('inventory').innerHTML=""; renderQuestion();
}

function renderQuestion(){
    const data = questions[currentIdx];
    document.getElementById('quiz-content').innerHTML = `
        <div class="text-center card-pop">
            <p class="text-[10px] font-bold text-stone-400 uppercase mb-2">Verrou ${currentIdx+1}/8</p>
            <h2 class="text-lg font-mono font-bold text-[#3e2723] mb-8 p-4 bg-stone-50 rounded-lg border border-dashed border-stone-300 min-h-[80px] flex items-center justify-center">${data.q}</h2>
            <input id="userAnswer" type="text" placeholder="Votre r√©ponse" class="px-3 py-2 rounded border text-[#3e2723] font-bold text-center mb-4"/>
            <div>
                <button onclick="checkCode()" class="bg-[#3e2723] text-[#faedcd] py-3 rounded-xl font-black uppercase shadow-lg active:scale-95 w-36">Valider</button>
                <p id="retry-msg" class="text-[10px] text-orange-700 font-bold h-4 uppercase mt-2"></p>
            </div>
        </div>
    `;
    updateUI();
}

function checkCode(){
    const userAns = document.getElementById("userAnswer").value.trim();
    const data = questions[currentIdx];
    if(userAns === ""){ alert("Entrez une r√©ponse"); return; }

    const isCorrect = (userAns === data.answer);
    sendToSheet(data.q, userAns, isCorrect);

    if(isCorrect){
        score++; addBadge(data.concept);
        document.getElementById('quiz-content').innerHTML = `
            <div class="text-center py-10 card-pop">
                <div class="text-6xl mb-4 animate-bounce">üîì</div>
                <h2 class="text-2xl font-black text-green-700">Excellent ! Continuez</h2>
                <button onclick="nextQuestion()" class="mt-8 bg-[#3e2723] text-white px-10 py-3 rounded-lg font-bold">Suivant</button>
            </div>`;
    } else {
        if(!hasRetried){
            hasRetried=true; attemptNumber=2;
            document.getElementById("retry-msg").innerText = "‚ö†Ô∏è Code invalide : Derni√®re tentative !";
        } else {
            document.getElementById('quiz-content').innerHTML = `
                <div class="text-center py-10 card-pop">
                    <div class="text-6xl mb-4">üö®</div>
                    <h2 class="text-2xl font-black text-red-700 font-mono">Pensez-y encore !</h2>
                    <p class="text-stone-500 italic mb-4">${data.hint}</p>
                    <button onclick="nextQuestion()" class="mt-4 bg-stone-200 px-10 py-3 rounded-lg font-bold">Suivant</button>
                </div>`;
            userLog.push({q:data.q, user:userAns, correct:false, solution:data.answer, hint:data.hint, level:currentIdx+1, attempt:attemptNumber});
        }
    }
}

function nextQuestion(){
    const data = questions[currentIdx];
    if(!hasRetried) attemptNumber=1;
    if(hasRetried && !userLog.find(u => u.q===data.q && u.attempt===2)){
        userLog.push({q:data.q, user:document.getElementById("userAnswer")?.value||"", correct:false, solution:data.answer, hint:data.hint, level:currentIdx+1, attempt:2});
    }
    currentIdx++; hasRetried=false; attemptNumber=1;
    if(currentIdx<questions.length) renderQuestion();
    else renderEnd();
}

function addBadge(conceptName){
    const inv = document.getElementById('inventory'); const empty=document.getElementById('empty-inv'); if(empty) empty.remove();
    inv.innerHTML+=`<div class="card-pop rarity-gold px-2 py-1 rounded flex flex-col items-center justify-center border shadow-sm min-w-[70px]">
        <span class="text-[7px] font-black uppercase text-[#3e2723] text-center">${conceptName}</span>
    </div>`;
}

function updateUI(){
    document.getElementById('prog-bar').style.width = (currentIdx/questions.length*100) + "%";
    document.getElementById('score-text').innerText = `Niveau ${currentIdx}/${questions.length}`;
}

function renderEnd(){
    document.getElementById('quiz-content').innerHTML = `
        <div class="text-center card-pop">
            <h2 class="text-6xl font-black text-[#3e2723]">${score}/${questions.length}</h2>
            <p class="font-bold text-[#bc6c25] uppercase text-xs mt-2">D√©chiffrement Termin√©</p>
            <div class="mt-6 text-left bg-stone-50 rounded-xl p-4 border max-h-[250px] overflow-y-auto">
                ${userLog.map((item,i)=>`
                    <div class="mb-3 pb-2 border-b border-stone-200 last:border-0">
                        <p class="text-[10px] font-bold">${i+1}. ${item.q}</p>
                        <p class="text-[9px] ${item.correct?'text-green-600':'text-red-600'}">R√©ponse : ${item.user} ${item.correct?'‚úÖ':'‚ùå (Sol: '+item.solution+')'}</p>
                        <p class="text-[8px] italic text-stone-400">Note : ${item.hint}</p>
                    </div>`).join('')}
            </div>
            <button onclick="location.reload()" class="mt-6 bg-[#3e2723] text-white px-10 py-4 rounded-xl font-bold w-full">Recommencer</button>
        </div>`;
}

// ----- Fonction pour envoyer les r√©ponses vers Google Sheet -----
function sendToSheet(question, answer, correct){
    fetch("TON_URL_GOOGLE_SCRIPT", {
        method:"POST",
        body: JSON.stringify({
            name: window.currentStudentName,
            question: question,
            answer: answer,
            correct: correct,
            level: currentIdx+1,
            attempt: attemptNumber
        })
    });
}
</script>

</body>
</html>
