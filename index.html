<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thermo : Le Code du Coffre</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .vault-wheel {
    background: linear-gradient(#3e2723, #5d4037, #3e2723);
    border: 2px solid #d4a373;
    text-shadow: 0 0 10px rgba(250, 237, 205, 0.5);
  }
  .bg-antique { background-color: #f5f2e9; background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png'); }
  .rarity-gold { border: 2px solid #b8860b; background: linear-gradient(135deg, #ffd700, #faf5b1); }
  @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }
  .shake { animation: shake 0.2s ease-in-out 0s 2; }
</style>
</head>
<body class="bg-antique min-h-screen font-sans text-stone-900">

<header class="bg-[#3e2723] text-[#faedcd] p-4 shadow-xl border-b-4 border-[#bc6c25] flex justify-between items-center">
  <h1 class="font-black uppercase tracking-tighter">Mission : Le Code du Coffre</h1>
  <div class="text-right border-l border-[#d4a373] pl-4">
    <input id="studentName" type="text" placeholder="Entrez votre nom" class="bg-[#faedcd] text-[#3e2723] px-2 py-1 rounded font-bold focus:outline-none"/>
  </div>
</header>

<main class="p-6 max-w-2xl mx-auto">
  <div class="flex justify-between text-[10px] font-bold uppercase mb-1 text-stone-500">
    <span>S√©curit√© du Coffre</span>
    <span id="score-text">Niveau 0/5</span>
  </div>
  <div class="h-2 bg-stone-300 rounded-full mb-8 overflow-hidden">
    <div id="prog-bar" class="h-full bg-[#8b4513] w-0 transition-all duration-500"></div>
  </div>

  <section id="game-zone" class="bg-white rounded-3xl shadow-2xl p-8 border-2 border-stone-200 relative">
    <div id="quiz-content">
      <div class="text-center py-12">
        <div class="text-6xl mb-6">üîê</div>
        <h2 class="text-2xl font-black text-[#3e2723] mb-4 uppercase">D√©chiffrez les D√©riv√©es</h2>
        <p class="text-stone-500 italic mb-8">Calculez les valeurs exactes pour d√©verrouiller le savoir thermodynamique.</p>
        <button onclick="startMission()" class="bg-[#3e2723] text-[#faedcd] px-12 py-4 rounded-xl font-bold hover:scale-105 transition-all">Commencer</button>
      </div>
    </div>
  </section>

  <div id="inventory" class="mt-10 grid grid-cols-5 gap-2"></div>
</main>

<script>
const questions = [
  { q: "Calculer ‚àÇf/‚àÇx pour f(x,y)=2x¬≤+y¬≥ au point (x=1, y=2).", answer: "4", hint: "La d√©riv√©e est 4x. Remplacez x par 1." },
  { q: "Pour f(x,y)=x¬≤/y + y¬≤/x, calculez ‚àÇf/‚àÇy au point (1,1).", answer: "-1", hint: "La d√©riv√©e est -x¬≤/y¬≤ + 2y/x. Remplacez x=1, y=1." },
  { q: "Calculez df pour f=2xy+x au point (1,1) si dx=1 et dy=0.", answer: "3", hint: "df = (2y+1)dx + (2x)dy. Ici 3*1 + 2*0." },
  { q: "Valeur de Œ±.V.T pour un gaz parfait si nR=1 ?", answer: "1", hint: "Œ± = 1/T pour un gaz parfait. Donc (1/T)*V*T = V. Si nR=1 et P=1, V=T." },
  { q: "Si f(x,y)=x*cos(y), que vaut ‚àÇ¬≤f/‚àÇy‚àÇx au point (1, 0) ?", answer: "0", hint: "‚àÇf/‚àÇx = cos(y). D√©rivez ensuite cos(y) par rapport √† y -> -sin(y). sin(0)=0." }
];

let currentIdx = 0;
let hasRetried = false;
let score = 0;
let studentName = '';

function startMission() {
  studentName = document.getElementById('studentName').value.trim();
  if(!studentName) { alert("Veuillez entrer votre nom pour commencer."); return; }
  currentIdx = 0; score = 0; hasRetried = false; renderQuestion();
}

function renderQuestion() {
  const data = questions[currentIdx];
  document.getElementById('quiz-content').innerHTML = `
    <div class="text-center">
      <p class="text-[10px] font-bold text-stone-400 uppercase mb-2">√ânigme ${currentIdx + 1}</p>
      <h2 class="text-xl font-mono font-bold text-[#3e2723] mb-8 p-4 bg-stone-50 rounded-lg border border-dashed border-stone-300">${data.q}</h2>
      <div class="flex justify-center gap-4 mb-10">
        ${renderWheel('sign')}
        ${renderWheel('num')}
      </div>
      <div class="flex flex-col gap-3">
        <button onclick="checkCode()" class="bg-[#3e2723] text-[#faedcd] py-4 rounded-xl font-black uppercase tracking-widest shadow-lg">Tenter le Code</button>
        <p id="retry-msg" class="text-xs text-orange-700 font-bold h-4"></p>
      </div>
    </div>
  `;
  updateUI();
}

function renderWheel(type) {
  const vals = type==='sign'?['+','-']:['0','1','2','3','4','5'];
  return `<div class="flex flex-col items-center">
    <button onclick="spin('${type}',1)" class="text-[#8b4513] text-xl font-bold">‚ñ≤</button>
    <div id="wheel-${type}" class="vault-wheel w-16 h-20 flex items-center justify-center text-3xl font-black text-white rounded-xl my-2 shadow-inner">${vals[0]}</div>
    <button onclick="spin('${type}',-1)" class="text-[#8b4513] text-xl font-bold">‚ñº</button>
  </div>`;
}

let currentSign = '+', currentNum = '0';

function spin(type, dir) {
  const vals = type==='sign'?['+','-']:['0','1','2','3','4','5'];
  if(type==='sign') {
    currentSign = currentSign==='+'?'-':'+';
    document.getElementById('wheel-sign').innerText = currentSign;
  } else {
    let idx = vals.indexOf(currentNum);
    idx = (idx+dir+vals.length)%vals.length;
    currentNum = vals[idx];
    document.getElementById('wheel-num').innerText = currentNum;
  }
}

function checkCode() {
  const userAns = (currentSign==='-'?'-':'') + currentNum;
  const finalAns = userAns.replace('+','');
  const data = questions[currentIdx];
  if(finalAns==data.answer) success();
  else fail();
}

function success() {
  score++;
  addBadge(questions[currentIdx].answer);
  saveAnswer(studentName, questions[currentIdx].q, questions[currentIdx].answer, true);
  document.getElementById('quiz-content').innerHTML = `
    <div class="text-center py-10 animate-bounce">
      <div class="text-6xl mb-4">üîì</div>
      <h2 class="text-2xl font-black text-green-700">CODE ACCEPT√â !</h2>
      <p class="text-stone-500 mt-2 italic">Excellent, continuez !</p>
      <button onclick="next()" class="mt-8 bg-[#3e2723] text-white px-8 py-3 rounded-lg">Suivant</button>
    </div>
  `;
}

function fail() {
  const container = document.getElementById('game-zone');
  container.classList.add('shake');
  setTimeout(() => container.classList.remove('shake'), 400);
  if(!hasRetried) {
    hasRetried = true;
    document.getElementById('retry-msg').innerText = "CODE ERRON√â : UNE DERNI√àRE TENTATIVE !";
  } else {
    saveAnswer(studentName, questions[currentIdx].q, currentSign+currentNum, false);
    document.getElementById('quiz-content').innerHTML = `
      <div class="text-center py-10">
        <div class="text-6xl mb-4">üö®</div>
        <h2 class="text-2xl font-black text-red-700">COFFRE BLOQU√â</h2>
        <p class="text-stone-500 mt-2 px-4">La solution √©tait ${questions[currentIdx].answer}.<br><small>${questions[currentIdx].hint}</small></p>
        <button onclick="next()" class="mt-8 bg-stone-200 px-8 py-3 rounded-lg">Continuer</button>
      </div>
    `;
  }
}

function next() {
  currentIdx++;
  hasRetried = false;
  currentSign = '+'; currentNum = '0';
  if(currentIdx < questions.length) renderQuestion();
  else renderEnd();
}

function addBadge(val) {
  document.getElementById('inventory').innerHTML += `<div class="h-12 w-12 rounded-full rarity-gold flex items-center justify-center font-black text-[#3e2723] border shadow-md text-xs">${val}</div>`;
}

function updateUI() {
  document.getElementById('prog-bar').style.width = (currentIdx/questions.length*100)+"%";
  document.getElementById('score-text').innerText = `Niveau ${currentIdx}/${questions.length}`;
}

function renderEnd() {
  document.getElementById('quiz-content').innerHTML = `
    <div class="text-center">
      <h2 class="text-5xl font-black text-[#3e2723]">${score}/${questions.length}</h2>
      <p class="font-bold text-stone-400 uppercase tracking-widest text-sm">Expertise du Coffre-Fort</p>
      <button onclick="location.reload()" class="mt-10 bg-[#3e2723] text-white px-10 py-4 rounded-xl font-bold">R√©initialiser le syst√®me</button>
    </div>
  `;
}

// Google Sheet integration
function saveAnswer(nom, question, reponse, correct) {
  fetch("https://script.google.com/macros/s/AKfycby4EvK1eJDNDLztfs38tvdwwSHbuSKhEhaSb8afX_BaZ4-ZonoBMMvTFG3yI8yYDa9DZg/exec", {
    method:"POST",
    body: JSON.stringify({nom, question, reponse, correct})
  });
}
</script>

</body>
</html>
